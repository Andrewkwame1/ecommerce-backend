#!/bin/bash
# Scaling and Load Testing Script
# This script scales the deployment and performs load testing

REPLICAS=${1:-3}
NAMESPACE=${2:-ecommerce}
DEPLOYMENT_NAME=${3:-ecommerce-api}

GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

echo "========================================"
echo "Scaling and Load Testing"
echo "========================================"
echo ""

# Check prerequisites
echo -e "${YELLOW}Checking prerequisites...${NC}"

if ! command -v kubectl &> /dev/null; then
    echo -e "  ${RED}✗${NC} kubectl is NOT installed"
    exit 1
fi
echo -e "  ${GREEN}✓${NC} kubectl is installed"

# Check if wrk is available
if command -v wrk &> /dev/null; then
    echo -e "  ${GREEN}✓${NC} wrk is installed"
    HAS_WRK=1
else
    echo -e "  ${YELLOW}!${NC} wrk is not installed (load testing will be skipped)"
    echo -e "    Install from: https://github.com/wg/wrk"
    HAS_WRK=0
fi

echo ""
echo -e "${YELLOW}Scaling deployment to $REPLICAS replicas...${NC}"
kubectl scale deployment/$DEPLOYMENT_NAME --replicas=$REPLICAS -n $NAMESPACE

if [ $? -ne 0 ]; then
    echo -e "  ${RED}✗${NC} Failed to scale deployment"
    exit 1
fi

echo -e "  ${GREEN}✓${NC} Deployment scaled successfully"

echo ""
echo -e "${YELLOW}Waiting for rollout to complete...${NC}"
kubectl rollout status deployment/$DEPLOYMENT_NAME -n $NAMESPACE --timeout=120s

if [ $? -ne 0 ]; then
    echo -e "  ${RED}✗${NC} Rollout failed"
    exit 1
fi

echo -e "  ${GREEN}✓${NC} Rollout completed successfully"

echo ""
echo -e "${CYAN}Current Pod Status:${NC}"
kubectl get pods -n $NAMESPACE -l app=$DEPLOYMENT_NAME

echo ""
echo -e "${CYAN}Resource Usage:${NC}"
kubectl top pods -n $NAMESPACE -l app=$DEPLOYMENT_NAME 2>/dev/null || echo -e "  ${YELLOW}Metrics server not available or pods not ready yet${NC}"

# Get service endpoint
echo ""
echo -e "${YELLOW}Getting service endpoint...${NC}"
SERVICE_PORT=$(kubectl get service ecommerce-api-service -n $NAMESPACE -o jsonpath='{.spec.ports[0].port}')

# Setup port-forward for testing
echo -e "${YELLOW}Setting up port-forward for testing...${NC}"
kubectl port-forward -n $NAMESPACE service/ecommerce-api-service 8080:$SERVICE_PORT > /dev/null 2>&1 &
PORT_FORWARD_PID=$!

sleep 3

TEST_URL="http://localhost:8080"

# Load testing with wrk
if [ $HAS_WRK -eq 1 ]; then
    echo ""
    echo -e "${YELLOW}Starting load test...${NC}"
    echo "  URL: $TEST_URL"
    echo "  Threads: 4"
    echo "  Connections: 50"
    echo "  Duration: 30s"
    echo ""
    
    wrk -t4 -c50 -d30s "$TEST_URL/ready/"
    
    echo ""
    echo -e "${GREEN}✓${NC} Load test completed"
else
    echo ""
    echo -e "${YELLOW}Skipping load test (wrk not installed)${NC}"
    echo -e "${YELLOW}Testing endpoint manually...${NC}"
    
    if curl -f -s "$TEST_URL/ready/" > /dev/null; then
        echo -e "  ${GREEN}✓${NC} Endpoint is responding"
    else
        echo -e "  ${RED}✗${NC} Endpoint test failed"
    fi
fi

# Cleanup port-forward
kill $PORT_FORWARD_PID 2>/dev/null

echo ""
echo -e "${CYAN}Final Status:${NC}"
kubectl get deployment/$DEPLOYMENT_NAME -n $NAMESPACE
echo ""
kubectl get pods -n $NAMESPACE -l app=$DEPLOYMENT_NAME

echo ""
echo "========================================"
echo -e "${GREEN}Scaling and Testing Complete!${NC}"
echo "========================================"
echo ""

